<html>
  <head>
    <script language="JavaScript">
      /*
       * Copyright: Microsoft 2019
       *
       * An example visualizer for use with Extruder simulators.
       */
      const svgns = "http://www.w3.org/2000/svg";
      const params = new URLSearchParams(window.location.search);
      const darkMode = params.get("_theme") === "dark";
      const debug = params.get("debug") === "true";

      // optional overrides for parameter names
      const levelKey = "LI100";
      const setPointKey = "LI100_SP";

      // set on load()
      let svgDoc = undefined;

      let maxTankHeight = 300;
      let tankOriginY = 0;

      // utility setAttributes
      function setAttributes(el, attributes) {
        for (var attr in attributes) el.setAttribute(attr, attributes[attr]);
      }

      function init() {
        // on load
        window.addEventListener("load", () => {
          svgDoc = document.getElementById("imported-svg").contentDocument;
          if (svgDoc) {
            // cache the tank height
            const tankLevel = svgDoc.getElementById("level");
            maxTankHeight = parseInt(tankLevel.getAttribute("height"));
            tankOriginY = parseInt(tankLevel.getAttribute("y"));

            // move the mask into a clipPath dynamically
            let clipPath = svgDoc.createElementNS(svgns, "clipPath");
            clipPath.setAttribute("id", "clip");
            const level = svgDoc.getElementById("level");
            level.appendChild(clipPath);
            const mask = svgDoc.getElementById("mask");
            clipPath.appendChild(mask);

            // apply the clipPath
            const tankWrapper = svgDoc.getElementById("tankWrapper");
            tankWrapper.setAttribute("style", "clip-path: url(#clip)");

            // adjust our colors based upon theme.
            if (darkMode) {
              document.body.style.backgroundColor = "#333";
              document.body.style.color = "white";

              const tank = svgDoc.getElementById("tank");
              const pipes = svgDoc.getElementById("pipes");
              tank.setAttribute("stroke", "white");
              pipes.setAttribute("stroke", "white");
            }
          } // if svgDoc

          // loading text
          if (debug) {
            const out = document.getElementById("out");
            out.textContent = "Waiting...";
          }
        });

        // on message
        window.addEventListener(
          "message",
          (event) => {
            // convert message to formatted JSON text for display
            const data = JSON.parse(event.data);
            const str = JSON.stringify(data, null, 2);

            if (debug) {
              const out = document.getElementById("out");
              out.textContent = str;
            }

            // read state out of message and convert units
            const level = data.state[levelKey];
            const setPoint = data.state[setPointKey]; // 10Hz

            // update positions of graphical elements
            if (svgDoc) {
              const tankLevel = svgDoc.getElementById("level");
              tankLevel.setAttribute(
                "height",
                `${(level / 100.0) * maxTankHeight}`
              );
              tankLevel.setAttribute(
                "y",
                `${(1.0 - level / 100.0) * maxTankHeight + tankOriginY}`
              );

              const tankSetPoint = svgDoc.getElementById("setPoint");
              tankSetPoint.setAttribute(
                "transform",
                `translate(0 ${(1.0 - setPoint / 100.0) * maxTankHeight})`
              );
            }
          },
          false
        );
      }
    </script>
  </head>
  <body>
    <pre
      id="out"
      style="font-size: x-small; display: box; position: absolute"
    ></pre>
    <object
      data="simpleTank.svg"
      type="image/svg+xml"
      id="imported-svg"
      width="100%"
      height="100%"
    ></object>
    <script language="JavaScript">
      init();
    </script>
  </body>
</html>
